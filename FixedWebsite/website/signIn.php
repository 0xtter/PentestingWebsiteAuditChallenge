<?php
include_once("config.php");

if (isset($_POST['but_submit'])) {


    $uname = mysqli_real_escape_string($con, $_POST['txt_uname']);
    $password = mysqli_real_escape_string($con, $_POST['txt_pwd']);

    if ($uname !== "" && $password !== "") {

        function decrypt($ciphertext, $passphrase)
        {
            $data = base64_decode($ciphertext);
            $ciphertext = substr($data, 16);
            $key = hash('SHA256', $passphrase, true);
            $iv = substr($data, 0, 16);

            return openssl_decrypt($ciphertext, 'AES-256-CTR', $key, 1, $iv);
        }

        $sql_query = "select * from users where username='" . $uname . "'";

        $result = mysqli_query($con, $sql_query);
        $row = mysqli_fetch_array($result);

        $salt = decrypt(explode(".", $row['password'])[1], '4wRVTZSo1EJY86B9ZNtL');
        $hash = hash("SHA256", $password . "JOI5Bs3C5O" . strlen($password) . $salt);
        $user = $row['id'];

        if (count($user) != 0 && $hash == explode(".", $row['password'])[0]) {
            session_start();
            $_SESSION['uname'] = $uname;
            $_SESSION["id"] = $user;
            header("Location: index.php");
        } else {
            header("Location: login.php");
        }
        exit();
    } else {
        header("Location: login.php");
        exit();
    }
}
?>
