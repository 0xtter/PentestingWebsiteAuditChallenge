<?php
include_once("config.php");
include_once("includes/utilities.php");

$title = "Ajout d'article";

redirect_login();

?>

<html>
<?php include("includes/head.php") ?>
<?php include("includes/header.php"); ?>
<body>
<article>
    <form method="post" action="" enctype="multipart/form-data">
        <label for="article_name">Nom de l'article :</label>
        <input type="text" id="article_name" name="article_name" required
               minlength="1" maxlength="100" size="50"><br/><br/>
        <textarea name="article_text" id="article_text" cols="50" rows="10"></textarea><br/><br/>
        <label for="article_image">Choisir une image d'illustration:</label>

        <input type="file"
               id="article_image" name="article_image"
               accept="image/png, image/jpeg">
        <br/><br/>
        <label for="article_private">Article privé : </label>

        <input type="checkbox" name="article_private" id="article_private"/>
        <br/><br/>
        <input type="submit" name="article_submit" value="Soumettre"/>

    </form>
</article>

<aside>

    <?php
    if (isset($_POST['article_submit'])) {

        $upload = true;

        //Gestion du fichier
        if (isset($_FILES["article_image"])) {
            $target_dir = "uploads/";
            $newfilename = date('dmYHis') . str_replace(" ", "", basename($_FILES["article_image"]["name"]));
            $target_file = $target_dir . $newfilename;

            if (!check_image($_FILES["article_image"])) {
                $upload = false;
                echo "Il y a eu un problème avec le type du fichier";
            } else if (!move_uploaded_file($_FILES["article_image"]["tmp_name"], $target_file)) {
                $upload = false;
                echo "Il y a eu un problème avec l'import du fichier";
            }
        }

        if ($upload) {

            $private = isset($_POST["article_private"]);

            $sql = "INSERT INTO news (title, content, filename, is_private, author_id) VALUES (?, ?, ?, ?, ?)";
            $stmt = $con->prepare($sql);

            $name = htmlspecialchars($_POST["article_name"]);
            $text = htmlspecialchars($_POST["article_text"]);

            $stmt->bind_param("sssii", $name, $text, $newfilename, $private, $_SESSION["id"]);
            $stmt->execute();

            $stmt->close();
            $con->close();
            echo("<strong> Article ajouté !</strong>");
        }


    }

    ?>


</aside>
</body>
</html>
